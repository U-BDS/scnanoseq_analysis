---
title: "scnanoseq and BLAZE published (Ground Truth/You et al): figures"
author:
  - name: "Austyn Trull"
  - name: "Lara Ianov, Ph.D."
output:
  html_document:
    code_folding: hide
    css: "style.css"
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
set.seed(1234)

library(ggplot2)
library(Seurat)
library(dplyr)
library(grid)

# add custom functions from UBDS R scripts
lapply(list.files("./scripts/R"), FUN = function(x) source(paste0("./scripts/R/", x)))

#### CONSTANT DEFS ####

## The prefix to output files
output_prefix <- "./output_BLAZE_dataset_figures"

dir.create(file.path(output_prefix), recursive = TRUE)
```

# Load pre-processed Seurat objects

From our previous analysis for each dataset groups (original BLAZE matrices / You et al data and BLAZE data re-processed with `nf-core/scnanoseq`),
load both objects into the environment

```{r}
scnanoseq_objs <- readRDS(file = "./output_BLAZE_scnanoseq_data/seurat_scnanoseq_BLAZE.rds")
blaze_objs <- readRDS(file = "./output_BLAZE_published_data/seurat_BLAZE_ground_truth.rds")
```

# Subset data to PromethION dataset

Focus on main BLAZE figures are for the PromethION datasets. Subset the dataset for gene and transcript level data across both analysis

```{r}
scnanoseq_promith <- scnanoseq_objs[c(5,6)]
blaze_promith <- blaze_objs[c(2,5)]

scnanoseq_promith
blaze_promith
```

# Correlation between datasets for nFeature and nCount

For the cell barcodes from scnanoseq which are present in the blaze set, we compute the correlation between the datasets for nFeature and nCount (for gene and transcript-level ; thus 4 plots total)

```{r}
# merge metadata based on barcodes from scnanoseq

merged_meta <- mapply(FUN = function(x,y) {
  
  scnano_meta <- x@meta.data
  blaze_meta <- y@meta.data
  
  # add BCs as column
  scnano_meta$cell_barcodes <- rownames(scnano_meta)
  blaze_meta$cell_barcodes <- rownames(blaze_meta)
  
  merged_meta <- merge(x = scnano_meta,
                       y = blaze_meta,
                       by = "cell_barcodes",
                       suffixes= c("_scnanoseq", "_You_et_al"))
  
}, x=scnanoseq_promith, y=blaze_promith, SIMPLIFY = FALSE)
```

```{r}
## nFeature scatters ##

# params

feature_type <- gsub(".*_","",names(merged_meta))
feature_1 <- "nFeature_RNA_scnanoseq"
feature_2 <- "nFeature_RNA_You_et_al"
output_feature <- "_nFeature.pdf"

mapply(FUN = function(x,y) {
  
  scatter_plot <- scatter_corr(data.frame = x,
                               feature = feature_1,
                               feature2 = feature_2,
                               feature_type = y,
                               title_size = 30,
                               axis_size = 15,
                               point_size = 2,
                               point_alpha = 0.5) + 
    theme(axis.title = element_text(size = 20))
  
  file_name <- paste0(output_prefix, "/", y, output_feature)

  #adding some room to the right to avoid axis being cutoff
  pdf(file = file_name, height = 8, width = 8)
  plot(scatter_plot + theme(plot.margin = margin(t = 20, b = 20, l = 50, r = 50)))
  dev.off()
  
}, x=merged_meta, y=feature_type)

## nCount scatters ##

# params

feature_type <- gsub(".*_","",names(merged_meta))
feature_1 <- "nCount_RNA_scnanoseq"
feature_2 <- "nCount_RNA_You_et_al"
output_feature <- "_nCount.pdf"

mapply(FUN = function(x,y) {
  
  scatter_plot <- scatter_corr(data.frame = x,
                               feature = feature_1,
                               feature2 = feature_2,
                               feature_type = y,
                               title_size = 30,
                               axis_size = 15,
                               point_size = 2,
                               point_alpha = 0.5) + 
    theme(axis.title = element_text(size = 20))
  
  file_name <- paste0(output_prefix, "/", y, output_feature)

  pdf(file = file_name, height = 8, width = 8)
  plot(scatter_plot + theme(plot.margin = margin(t = 20, b = 20, l = 50, r = 50)))
  dev.off()
  
}, x=merged_meta, y=feature_type)
```

# UMAPS across PromethION datasets

```{r}
feature_type <- c("gene", "transcript") # for coloring purposes

UMAPs <- mapply(FUN = function(x, y, z) {
  
  title_col <- ifelse(z == "gene", "#0072B2", "#009E73")
  
  p1 <- DimPlot(x,
                reduction = "umap",
                label = FALSE,
                pt.size = NULL) + 
    guides(color = guide_legend(override.aes = list(size = 4), ncol=1)) +
    ggtitle(paste0("scnanoseq: ", y)) +
    theme(legend.text = element_text(size = 15),
          axis.title = element_text(size = 20),
          axis.text.x = element_text(size=15),
          axis.text.y = element_text(size=15),
          plot.title = element_text(size = 25, color = title_col),
          strip.text.x = element_text(size = 20, face = "bold"))
  
  return(p1)
  
}, x = scnanoseq_promith, y = names(scnanoseq_promith), z = feature_type)


pdf(paste0(output_prefix, "/","UMAPS_scnanoseq.pdf"),
    width = 8,
    height = 8)

gridExtra::grid.arrange(grobs = UMAPs)

dev.off()


UMAPs <- mapply(FUN = function(x, y, z) {
  
  title_col <- ifelse(z == "gene", "#0072B2", "#009E73")
  
  p1 <- DimPlot(x,
                reduction = "umap",
                label = FALSE,
                pt.size = NULL) + 
    guides(color = guide_legend(override.aes = list(size = 6), ncol=1)) +
    ggtitle(paste0("You et al: ", y)) +
    theme(legend.text = element_text(size = 15),
          axis.title = element_text(size = 20),
          axis.text.x = element_text(size=15),
          axis.text.y = element_text(size=15),
          plot.title = element_text(size = 25, color = title_col),
          strip.text.x = element_text(size = 20, face = "bold"))
    
  
  return(p1)
  
}, x = blaze_promith, y = names(scnanoseq_promith), z = feature_type) # using names from scnanoseq object for consistency in figures


pdf(paste0(output_prefix, "/","UMAPS_You_et_al.pdf"),
    width = 8,
    height = 8)

gridExtra::grid.arrange(grobs = UMAPs)

dev.off()
```

# nFeature UMAPs across PromethION datasets

```{r}
feature_type <- c("gene", "transcript") # for coloring purposes

UMAPs <- mapply(FUN = function(x, y, z) {
  
  title_col <- ifelse(z == "gene", "#0072B2", "#009E73")

  p1 <- FeaturePlot(x,
                    reduction = "umap",
                    features = "nFeature_RNA",
                    label = FALSE,
                    pt.size = NULL) + 
    ggtitle(paste0("scnanoseq: ", y)) +
    theme(legend.text = element_text(size = 15),
          legend.title = element_text(size = 15),
          axis.title = element_text(size = 20),
          axis.text.x = element_text(size=15),
          axis.text.y = element_text(size=15),
          plot.title = element_text(size = 25, color = title_col)) +
    labs(color = "Feature count")
    
  
  return(p1)
  
}, x = scnanoseq_promith, y = names(scnanoseq_promith), z = feature_type)


pdf(paste0(output_prefix, "/","FeaturePlot_nFeature_scnanoseq.pdf"),
    width = 8,
    height = 8)

gridExtra::grid.arrange(grobs = UMAPs)

dev.off()


UMAPs <- mapply(FUN = function(x, y, z) {
  
  title_col <- ifelse(z == "gene", "#0072B2", "#009E73")

  p1 <- FeaturePlot(x,
                    reduction = "umap",
                    features = "nFeature_RNA",
                    label = FALSE,
                    pt.size = NULL) + 
    ggtitle(paste0("You et al: ", y)) +
    theme(legend.text = element_text(size = 15),
          legend.title = element_text(size = 15),
          axis.title = element_text(size = 20),
          axis.text.x = element_text(size=15),
          axis.text.y = element_text(size=15),
          plot.title = element_text(size = 25, color = title_col)) +
    labs(color = "Feature count")
  
  
  return(p1)
  
}, x = blaze_promith, y = names(scnanoseq_promith), z = feature_type)


pdf(paste0(output_prefix, "/","FeaturePlot_nFeature_You_et_al.pdf"),
    width = 8,
    height = 8)

gridExtra::grid.arrange(grobs = UMAPs)

dev.off()
```

# Gene specific FeaturePlot and violin plots

Gene selected are based from the original Blaze analysis as examples of expression profiles from the original data vs scnanoseq.

```{r}
genes_of_interest <- c("PAX6", "VIM", "ELAVL4", "NRN1")

### Gene ###

markers <- read.table("input/references/blaze_gene_markers_gencode_v31_full.csv",
                      sep=",",
                      header = TRUE,
                      row.names = NULL)

# fetch Ensembl IDs

markers_subset <- dplyr::filter(markers, gene_name %in% genes_of_interest)

# gene only obj

genes_feature <- mapply(FUN = function(x) {
  
  gene_name <- unique(markers_subset$gene_name[markers_subset$gene_id==x])

  p1 <- FeaturePlot(scnanoseq_promith$ERR9958135_gene,
                    reduction = "umap",
                    slot = "data",
                    features = x,
                    label = FALSE,
                    cols = c("#D3D3D3", "#0072B2")) + 
    ggtitle(paste0(x, " | ",  gene_name)) +
    theme(legend.text = element_text(size = 15),
          legend.title = element_text(size = 15),
          axis.title = element_text(size = 20),
          plot.title = element_text(size = 20),
          axis.text.x = element_text(size=15),
          axis.text.y = element_text(size=15))
  
  return(p1)
  
}, x = unique(markers_subset$gene_id))

pdf(paste0(output_prefix, "/","FeaturePlot_genes_scnanoseq.pdf"),
    width = 10,
    height = 8)

gridExtra::grid.arrange(grobs = genes_feature, top=textGrob("scnanoseq: ERR9958135_gene", gp = gpar(fontsize = 25, fontface = "bold")))

dev.off()

genes_feature <- mapply(FUN = function(x) {
  
  gene_name <- unique(markers_subset$gene_name[markers_subset$gene_id==x])

  p1 <- FeaturePlot(blaze_objs$promith_gene,
                    reduction = "umap",
                    features = x,
                    label = FALSE,
                    cols = c("#D3D3D3", "#0072B2")) + 
    ggtitle(paste0(x, " | ",  gene_name)) +
    theme(legend.text = element_text(size = 15),
          legend.title = element_text(size = 15),
          axis.title = element_text(size = 20),
          plot.title = element_text(size = 20),
          axis.text.x = element_text(size=15),
          axis.text.y = element_text(size=15))
  
  return(p1)
  
}, x = unique(markers_subset$gene_id))

pdf(paste0(output_prefix, "/","FeaturePlot_genes_blaze.pdf"),
    width = 10,
    height = 8)

gridExtra::grid.arrange(grobs = genes_feature, top=textGrob("You et al: ERR9958135_gene", gp = gpar(fontsize = 25, fontface = "bold")))

dev.off()


### Transcript ###

# representative list for illustration purposes
# based on IDs we will fetch transcript name to be user-friendly
# IDs for transcripts from same genes plotted above
transcript_id <- c("ENST00000241001.13", "ENST00000379111.7", "ENST00000639916.1",
                   "ENST00000544301.7", "ENST00000485947.1", "ENST00000487938.5",
                   "ENST00000357083.8", "ENST00000371823.8", "ENST00000244766.7")

# ensure all are present in marker set

stopifnot(all(transcript_id %in% markers_subset$transcript_id))

transcript_feature <- mapply(FUN = function(x) {
  
  trans_name <- markers_subset$transcript_name[markers_subset$transcript_id==x]

  p1 <- FeaturePlot(scnanoseq_promith$ERR9958135_transcript,
                    reduction = "umap",
                    slot = "data",
                    features = x,
                    label = FALSE,
                    cols = c("#D3D3D3", "#009E73")) + 
    ggtitle(paste0(x, " | ",  trans_name)) +
    theme(legend.text = element_text(size = 15),
          legend.title = element_text(size = 15),
          axis.title = element_text(size = 20),
          plot.title = element_text(size = 20),
          axis.text.x = element_text(size=15),
          axis.text.y = element_text(size=15))
  
  return(p1)
  
}, x = transcript_id)

pdf(paste0(output_prefix, "/","FeaturePlot_transcripts_scnanoseq.pdf"),
    width = 15,
    height = 10)

gridExtra::grid.arrange(grobs = transcript_feature, top=textGrob("scnanoseq: ERR9958135_transcript", gp = gpar(fontsize = 25, fontface = "bold")))

dev.off()

transcript_feature <- mapply(FUN = function(x) {

  trans_name <- markers_subset$transcript_name[markers_subset$transcript_id==x]
  
  p1 <- FeaturePlot(blaze_objs$promith_trans,
                    reduction = "umap",
                    slot = "data",
                    features = x,
                    label = FALSE,
                    cols = c("#D3D3D3", "#009E73")) + 
    ggtitle(paste0(x, " | ",  trans_name)) +
    theme(legend.text = element_text(size = 15),
          legend.title = element_text(size = 15),
          axis.title = element_text(size = 20),
          plot.title = element_text(size = 20),
          axis.text.x = element_text(size=15),
          axis.text.y = element_text(size=15))
  
  return(p1)
  
}, x = transcript_id)

pdf(paste0(output_prefix, "/","FeaturePlot_transcripts_You_et_al.pdf"),
    width = 15,
    height = 10)

gridExtra::grid.arrange(grobs = transcript_feature, top=textGrob("You et al: ERR9958135_transcript", gp = gpar(fontsize = 25, fontface = "bold")))

dev.off()
```
